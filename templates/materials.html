{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Materials</h2>
  <a class="btn btn-primary" href="{{ url_for('add_material') }}">Add Material</a>
</div>

<form class="row g-2 mb-3" method="get" action="{{ url_for('materials') }}">
  <div class="col-md-3">
    <label class="form-label">Date From</label>
    <input type="date" name="date_from" class="form-control" value="{{ filters.date_from }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Date To</label>
    <input type="date" name="date_to" class="form-control" value="{{ filters.date_to }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Material Name</label>
    <select name="material_name" class="form-select" multiple>
      {% for m in material_names %}
      <option value="{{ m }}" {% if m in filters.material_name %}selected{% endif %}>{{ m }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Team Member</label>
    <select name="team_member" class="form-select" multiple>
      {% for t in team_members %}
      <option value="{{ t }}" {% if t in filters.team_member %}selected{% endif %}>{{ t }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Work ID</label>
    <select name="work_id" class="form-select" multiple>
      {% for wid in work_ids %}
      <option value="{{ wid }}" {% if wid|string in filters.work_id %}selected{% endif %}>{{ wid }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Search</label>
    <input class="form-control" name="q" placeholder="material, description" value="{{ filters.q }}">
  </div>
  <div class="col-md-4 d-flex align-items-end">
    <button class="btn btn-secondary me-2">Filter</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('materials') }}">Reset</a>
    <a class="btn btn-success" href="{{ url_for('export_materials',
                      date_from=filters.date_from,
                      date_to=filters.date_to,
                      material_name=filters.material_name,
                      team_member=filters.team_member,
                      work_id=filters.work_id,
                      q=filters.q) }}">
      Export
    </a>
  </div>
</form>

<!-- <div class="table-responsive">
    <table class="table table-striped table-bordered"> -->
<div class="table-responsive">
  <table class="table table-striped table-bordered table-sm table-compact align-middle">

    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Material</th>
        <th>Qty</th>
        <th>Work ID</th>
        <th>Work Date</th>
        <th>Team Member</th>
        <th>Description</th>
        <th style="width: 140px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in materials %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.material_name }}</td>
        <td>{{ r.quantity_used if r.quantity_used is not none else '' }}</td>
        <td>{{ r.work_id if r.work_id is not none else '' }}</td>
        <td>{{ r.work_date or '' }}</td>
        <td>{{ r.team_member or '' }}</td>
        <td>{{ r.work_description or '' }}</td>
        <!-- <td>
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_material', material_id=r.id) }}">Edit</a>
              <form method="post" action="{{ url_for('delete_material', material_id=r.id) }}" class="d-inline" onsubmit="return confirm('Delete material #{{ r.id }}?');">
                <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
              </form>
            </td> -->
        <td> <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_material', material_id=r.id) }}">Edit</a>
           {% if current_user.is_authenticated and current_user.role == 'admin' %} 
           <form method="post" action="{{ url_for('delete_material', material_id=r.id)}}" class="d-inline"
            onsubmit="return confirm('Delete material #{{ r.id }}?');"> <button class="btn btn-sm btn-outline-danger"
              type="submit">Delete</button> </form> {% endif %} </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="8" class="text-center text-muted">No records</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
